<!DOCTYPE html>
<html>
<head>
  <title>Karma Police Login Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="../css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link href="../css/bootstrap-theme.min.css" rel="stylesheet" media="screen">
  <link rel="stylesheet/less" href="../less/styles.css" type="text/css">
  <script src="../js/less.js"></script>  
  <link href="../css/style.css" rel="stylesheet" media="screen">
  <link href="../css/navbars.css" rel="stylesheet" media="screen">
  <link href="css/style.css" rel="stylesheet" media="screen">
  <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,400italic|Lobster|Exo+2:400,800,700,600,500,200,200italic,300,300italic,400italic,900' rel='stylesheet' type='text/css'>
  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
  <script src="http://yui.yahooapis.com/3.14.1/build/yui/yui-min.js"></script>  
  <script src="http://www.parsecdn.com/js/parse-1.2.16.min.js"></script>
  <script src="../js/bootstrap.min.js"></script>
  <script src="../js/main_script.js"></script>
  <script src="js/script.js"></script>
  
</head>

<body class="all-app-pages">

  <!--facebookapp initialization-->

  <div id="fb-root"></div>

<script type="text/javascript">

  //initialize parse//

  Parse.initialize("x03F3RJiRYdtYPfeS7AHNOEDHL0cx2nzzJ4ztDOX", "mYTgTArAtPa24wEcsXfUQYT6NQmI0iG5iR6xHHDL"); 

     // Load the SDK asynchronously
     (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "http://connect.facebook.net/en_US/all.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));

     window.fbAsyncInit = function() {

      // init the FB JS SDK
      Parse.FacebookUtils.init({
      appId      : '254848478004741', // Facebook App ID
      channelUrl : 'http://studio.generalassemb.ly/FEWD20/Liz_Lambos/FEWD_final_project/channel.html', // Channel File
      status     : true, // check login status
      cookie     : true, // enable cookies to allow Parse to access the session
      xfbml      : true  // parse XFBML
      });


      function initiateFBLogin() {

  var user = Parse.User.current();

  Parse.FacebookUtils.logIn("user_friends,email", {
    success: function(user) {

      function setKPUserName() {
        FB.api('/me', function(response) {
          if (!response.error) {
            var userName = response.name;
            console.log(userName);
            user.set("username", userName); 
            var userFbID = response.id;
            console.log(typeof userFbID);
            console.log(userFbID);
            var userEmail = response.email;
            console.log(userEmail);
            user.set("email", userEmail);
            user.set("fbID", userFbID); 
            user.save(null, {
              success: function(user) {

              },
              error: function(user, error) {
                console.log("Oops, something went wrong saving your name.");
              }
            });

          } 
          else {
            console.log("Oops something went wrong with facebook.");
          }
        });

      }//set name

      function getPhoto(){
        FB.api('/me/picture?type=normal', function(response) {

          var str= response.data.url;
          console.log(str);

          user.set("userPic", str);

          var userPic = user.get("userPic");
          console.log(userPic);
          user.save(null, {
            success: function(user) {

            },
            error: function(user, error) {
              console.log("Oops, something went wrong saving your name.");
            }
          });
        });

      } //get photo


      function getFriends() {
        FB.api('/me/friends', function(response) {
          if(response.data) {
           var friendsArray = response.data; 
           console.log(friendsArray);

           user.set("fbFriends", friendsArray);
           user.save();

           var currUserFriends = user.get("fbFriends");
           console.log(currUserFriends);

         } else {
          console.log("Error!");
        }
      });


}//get friends

if (!user.existed()) {
  console.log(user.id);
  setKPUserName();
  getPhoto(); 
  getFriends();
  user.set("karmaPointsBalance",0);
  user.set("answersGivenBalance",0);
  user.set("answersGottenBalance",0);
  user.set("friendsInvitedBalance",0);
  user.save();
  console.log("User signed up and logged in through Facebook!");
}

else {
  console.log(user.id);
  setKPUserName();
  getPhoto();
  getFriends();
  console.log("User logged in through Facebook!");
}
},

error: function(user, error) {
 console.log("User cancelled the Facebook login or did not fully authorize."); }

});


//prompt for login if not connected


FB.Event.subscribe('auth.authResponseChange', function(response) {
    // Here we specify what we do with the response anytime this event occurs. 
    if (response.status === 'connected') {
      console.log(response.status);
      user = Parse.User.current();

      //This is very strange, but if i dont have these tests the redirect will happen without the user being recognized as a parse currrent user
      //with them it keeps looping through until the user is set

      var testy3 = user.id;
      console.log(testy3);
      var testy = user.get("username");
      console.log(testy);

      if (testy != 'undefined' || testy != "") {
        // redirect();

        Parse.FacebookUtils.login().then(function(){
          redirect();
        });
      }
    

   } 
   else if (response.status === 'not_authorized') {
     console.log(response.status);
     Parse.FacebookUtils.login();
        //location.reload(true);
      } 

      else {
       console.log(response.status);
       Parse.FacebookUtils.login();
        //location.reload(true);
      }
    });


}//initiate FB login

//redirect to the next page

function redirect()
{
  window.location.href='../get_karma_page/index.html';
}

function redirect2()
{
  window.location.href='../login_page/index.html';
}

    }



</script>

   <!--end facebookapp initialization--> 

   <div class="signin_container">
    <h1 class="navbar-brand navbar-brand1">Karma</h1>
    <h1 class="navbar-brand navbar-brand2">Police</h1>
    <button id="fb_login_button" class="btn btn-lg btn-primary fb_button">Sign-in with Facebook</button>
  
    <label for="" class="label-warning login_label">We will NEVER post to your Facebook!</label>

  </div>


  <footer class="screen-footer fixed-bottom">
    <div class="footer-container">
      <p class="hidden-xs">KarmaPolice 2013</p>
      <nav class="corporate-info">
        <ul class="bottom-links">

        </ul>
      </nav>


    </div>

  </footer>
  <!-- end footer-->

</body>
</html>